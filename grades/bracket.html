<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Math Quiz Bracket</title>
  <link rel="stylesheet" href="../static/styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <nav class="back-nav">
    <a href="../index.html" class="back-home-btn">‚Üê Back to Home</a>
  </nav>

  <h1 id="page-title">Math Quiz Competition</h1>
  <div id="bracket"></div>

  <script>
    // Get grade from URL parameter (?grade=10)
    const urlParams = new URLSearchParams(window.location.search);
    const grade = urlParams.get('grade') || '10'; // Default to grade 10

    // Update page title
    document.getElementById('page-title').textContent = `Grade ${grade} ‚Äì Math Quiz Competition`;
    document.title = `Grade ${grade} Math Quiz Bracket`;

    // Load the appropriate JSON file
    const jsonFile = `../data/competition-grade${grade}.json`;

    fetch(jsonFile)
      .then(res => {
        if (!res.ok) {
          throw new Error(`Failed to load data for Grade ${grade}`);
        }
        return res.json();
      })
      .then(data => {
        const bracket = document.getElementById("bracket");

        data.rounds.forEach(round => {
          const roundDiv = document.createElement("div");
          roundDiv.className = "round";

          const title = document.createElement("div");
          title.className = "round-title";
          title.textContent = round.name;
          roundDiv.appendChild(title);

          // Sort matches: completed first (by date), pending last
          const sortedMatches = round.matches.sort((a, b) => {
            const isPendingA = isMatchPending(a);
            const isPendingB = isMatchPending(b);

            if (isPendingA && !isPendingB) return 1;
            if (!isPendingA && isPendingB) return -1;
            if (isPendingA && isPendingB) return 0;

            const dateA = parseDate(a.schedule.date);
            const dateB = parseDate(b.schedule.date);

            return dateA - dateB;
          });

          sortedMatches.forEach(match => {
            const matchDiv = document.createElement("div");
            matchDiv.className = "match";
            
            // Best loser match styling
            const isBestLoser = match.type === "best_loser";
            if (isBestLoser) {
              matchDiv.style.background = "#fff9e6";
              matchDiv.style.borderLeft = "4px solid #f59e0b";
            }

            // Schedule info
            const scheduleDiv = document.createElement("div");
            scheduleDiv.className = "match-schedule";
            scheduleDiv.innerHTML = `
              <span>üìÖ ${match.schedule.date}</span>
              <span>üïí ${match.schedule.time}</span>
              <span>üìç ${match.schedule.location}</span>
            `;
            matchDiv.appendChild(scheduleDiv);

            // Best loser banner
            if (isBestLoser) {
              const bannerDiv = document.createElement("div");
              bannerDiv.className = "best-loser-banner";
              bannerDiv.textContent = "‚ö° Best Loser Playoff";
              matchDiv.appendChild(bannerDiv);
            }

            // Teams section
            const teamsDiv = document.createElement("div");
            teamsDiv.className = "match-teams";

            // Team A
            const teamADiv = document.createElement("div");
            teamADiv.className = "team";
            const teamAName = document.createElement("div");
            teamAName.className = "team-name";
            teamAName.textContent = match.teamA.name || "TBD";
            teamADiv.appendChild(teamAName);

            if (match.teamA.points !== null) {
              const pointsA = document.createElement("div");
              pointsA.className = "points";
              pointsA.textContent = match.teamA.points;
              teamADiv.appendChild(pointsA);
            }
            teamsDiv.appendChild(teamADiv);

            // VS
            const vsDiv = document.createElement("div");
            vsDiv.className = "vs";
            vsDiv.textContent = "VS";
            teamsDiv.appendChild(vsDiv);

            // Team B
            const teamBDiv = document.createElement("div");
            teamBDiv.className = "team";
            const teamBName = document.createElement("div");
            teamBName.className = "team-name";
            teamBName.textContent = match.teamB.name || "TBD";
            teamBDiv.appendChild(teamBName);

            if (match.teamB.points !== null) {
              const pointsB = document.createElement("div");
              pointsB.className = "points";
              pointsB.textContent = match.teamB.points;
              teamBDiv.appendChild(pointsB);
            }
            teamsDiv.appendChild(teamBDiv);

            matchDiv.appendChild(teamsDiv);

            // Winner banner
            if (match.winner) {
              const winnerDiv = document.createElement("div");
              winnerDiv.className = "winner-banner";
              winnerDiv.textContent = `üèÜ Winner: ${match.winner}`;
              matchDiv.appendChild(winnerDiv);
            }

            roundDiv.appendChild(matchDiv);
          });

          bracket.appendChild(roundDiv);
        });
      })
      .catch(error => {
        console.error(error);
        document.getElementById("bracket").innerHTML = 
          `<div style="text-align: center; padding: 50px; color: #ef4444;">
            <h2>‚ö†Ô∏è Error Loading Bracket</h2>
            <p>${error.message}</p>
            <p>Please check if Grade ${grade} data exists.</p>
          </div>`;
      });

    // Helper functions
    function isMatchPending(match) {
      const date = match.schedule?.date?.toLowerCase() || "";
      return date.includes("pending") || date.includes("panding") || date.includes("tbd");
    }

    function parseDate(dateStr) {
      if (!dateStr || isMatchPending({ schedule: { date: dateStr } })) {
        return new Date('9999-12-31');
      }

      const parts = dateStr.split('/');
      if (parts.length === 3) {
        const [day, month, year] = parts;
        return new Date(`20${year}`, month - 1, day);
      }

      return new Date('9999-12-31');
    }
  </script>
</body>
</html>
